# Agent OS v3 Architecture (Current Release: v4.7.1)

## Overview

This directory contains the **v3 architecture** source templates that get installed to target projects. The "v3" refers to the architectural approach (native hooks, single-source JSON), while the current release version is **v4.7.1**.

Agent OS v3 architecture is a major refactor that leverages Claude Code's native capabilities to simplify the framework while improving reliability.

**No external dependencies** - uses only Claude Code's built-in tools (Bash, Read, Write, Grep, Task).

> **Note**: Files in this directory are templates. Run `./setup/project.sh --claude-code --target /path/to/project` to install them.

## Key Changes from v2.x

| Feature | v2.x | v3.0 |
|---------|------|------|
| **Task Format** | Dual (MD + JSON with sync) | Single-source JSON |
| **Instructions** | Embedded (250-900 lines/command) | Native memory hierarchy |
| **Phases** | Manual Read loading | Native subagents |
| **Validation** | Skills (can be skipped) | Hooks (mandatory) |
| **Task Sync** | task-sync skill | PostToolUse hook |
| **Recovery** | Custom state patterns | Native checkpointing |
| **Operations** | Inline code | Shell script utilities |

## Architecture

```
.claude/
├── CLAUDE.md                    # Core Agent OS memory (auto-loaded)
├── settings.json                # Hooks configuration
├── rules/
│   ├── tdd-workflow.md          # TDD rules (path-specific)
│   ├── git-conventions.md       # Git rules
│   └── execute-tasks.md         # Task execution rules
├── agents/
│   ├── phase1-discovery.md      # Task discovery (inherits model)
│   ├── phase2-implementation.md # TDD implementation (inherits model)
│   ├── phase3-delivery.md       # Completion workflow (inherits model)
│   ├── wave-orchestrator.md     # Parallel wave execution
│   ├── subtask-group-worker.md  # Parallel subtask execution
│   ├── execute-spec-orchestrator.md # Automated spec execution state machine
│   ├── wave-lifecycle-agent.md  # Wave branch management (v4.6)
│   ├── pr-review-discovery.md   # PR comment analysis
│   ├── pr-review-implementation.md # PR feedback implementation
│   ├── comment-classifier.md    # Comment priority classification (haiku)
│   ├── future-classifier.md     # Deferred item classification (haiku)
│   ├── roadmap-integrator.md    # Roadmap phase placement (haiku)
│   ├── git-workflow.md          # Branch management, commits, PRs
│   ├── project-manager.md       # Task/roadmap state updates
│   ├── test-discovery.md        # Browser test discovery (v4.7)
│   ├── test-executor.md         # Browser test execution (v4.7)
│   └── test-reporter.md         # Test result reporting (v4.7)
├── hooks/
│   ├── session-start.sh         # Load progress context
│   ├── session-end.sh           # Save checkpoint
│   ├── post-file-change.sh      # Regenerate tasks.md
│   └── pre-commit-gate.sh       # Validate before commit
└── scripts/
    ├── json-to-markdown.js      # Generate MD from JSON
    ├── task-operations.sh       # Task management utilities
    ├── branch-setup.sh          # Wave branch creation
    ├── pr-review-operations.sh  # PR review utilities
    ├── execute-spec-operations.sh # Execute-spec state management
    ├── test-operations.sh       # Browser test utilities (v4.7)
    ├── test-plan-to-markdown.js # Test plan MD generation (v4.7)
    └── test-report-to-markdown.js # Test report MD generation (v4.7)

.agent-os/
├── specs/[spec]/
│   ├── tasks.json               # SOURCE OF TRUTH
│   └── tasks.md                 # Auto-generated (read-only)
├── progress/
│   └── progress.json            # Cross-session memory
└── state/
    ├── session.json             # Current session
    └── checkpoints/             # Recovery points
```

## Why These Changes?

### 1. Hooks Over Skills

**Problem**: Skills are model-invoked—Claude decides when to use them. This means validation could be skipped.

**Solution**: Hooks are deterministic. `PreToolUse` hooks **always run** before the tool executes. A pre-commit hook that blocks on failing tests cannot be bypassed.

### 2. Single-Source Task Format

**Problem**: v2.x had `tasks.md` as source of truth and `tasks.json` as machine-readable. This caused sync drift requiring a dedicated `task-sync` skill, startup validation, and commit gates.

**Solution**: `tasks.json` is the single source. `tasks.md` is auto-generated by hooks whenever JSON changes. No sync logic needed.

### 3. Native Subagents Over Phase Files

**Problem**: Phase files had to be loaded with the Read tool, with "MANDATORY" gates that could still be skipped.

**Solution**: Native subagents are invoked via Task tool with:
- `tools:` restriction (can't access unauthorized tools)
- `skills:` auto-loading (relevant skills always available)
- `model:` specification (use haiku for fast phases)

### 4. Memory Hierarchy Over Embedded Instructions

**Problem**: Commands were 250-900 lines with all instructions embedded for reliability.

**Solution**: Claude Code's native memory hierarchy:
- `.claude/CLAUDE.md` - Core instructions (always loaded)
- `.claude/rules/*.md` - Path-specific rules with YAML frontmatter
- Automatic loading by Claude Code (no Read tool needed)

### 5. Shell Script Over Inline Operations

**Problem**: Task operations were implemented inline in commands or via MCP servers.

**Solution**: Single shell script (`task-operations.sh`) provides all operations:
- Uses `jq` for JSON manipulation
- Uses `git` for artifact collection
- Uses `grep` for name validation
- Called via Bash tool (no external dependencies)

## Task Operations

All task management uses `"${CLAUDE_PROJECT_DIR}/.claude/scripts/task-operations.sh"`:

```bash
# Get status
bash "${CLAUDE_PROJECT_DIR}/.claude/scripts/task-operations.sh" status [spec_name]

# Update task
bash "${CLAUDE_PROJECT_DIR}/.claude/scripts/task-operations.sh" update <task_id> <status>

# Add artifacts
bash "${CLAUDE_PROJECT_DIR}/.claude/scripts/task-operations.sh" artifacts <task_id> <json>

# Collect artifacts from git
bash "${CLAUDE_PROJECT_DIR}/.claude/scripts/task-operations.sh" collect-artifacts [since_commit]

# Validate names exist in codebase
bash "${CLAUDE_PROJECT_DIR}/.claude/scripts/task-operations.sh" validate-names '["functionName"]'

# Get progress log
bash "${CLAUDE_PROJECT_DIR}/.claude/scripts/task-operations.sh" progress [count] [type]

# Log progress entry
bash "${CLAUDE_PROJECT_DIR}/.claude/scripts/task-operations.sh" log-progress <type> <description>
```

## Native Claude Code Agent Integration (v3.0.0)

v3.0 now includes Planning Mode and Explore agent integration:

### Planning Mode

Used in `/shape-spec` for formal exploration:

| Step | Tool | Purpose |
|------|------|---------|
| Start | `EnterPlanMode` | Restrict to read-only, signal exploration |
| End | `ExitPlanMode` | Get user approval, ready for implementation |

### Explore Agent

Integrated across commands with thoroughness levels:

| Command/Agent | Thoroughness | Use Case |
|---------------|--------------|----------|
| phase1-discovery | `quick` | Spec discovery, context loading |
| shape-spec (quick) | `quick` | Fast validation |
| shape-spec (standard) | `medium` | Balanced exploration |
| shape-spec (deep) | `very thorough` | Complex features |
| debug | `very thorough` | Root cause investigation |

## Source Templates

```
v3/
├── README.md                    # This file
├── UPGRADE-PLAN.md              # Historical migration guide (v2→v3)
├── schemas/
│   ├── tasks-v3.json            # JSON schema for tasks
│   └── execute-spec-v1.json     # Execute-spec state schema
├── settings.json                # Hooks configuration
├── hooks/
│   ├── session-start.sh
│   ├── session-end.sh
│   ├── post-file-change.sh
│   └── pre-commit-gate.sh
├── scripts/
│   ├── json-to-markdown.js
│   ├── task-operations.sh       # Task management
│   ├── branch-setup.sh          # Wave branching
│   ├── pr-review-operations.sh  # PR review utilities
│   ├── execute-spec-operations.sh # Execute-spec state
│   ├── test-operations.sh       # Browser test utilities
│   ├── test-plan-to-markdown.js # Test plan generation
│   └── test-report-to-markdown.js # Test report generation
├── agents/                      # 17 specialized agents
│   ├── phase1-discovery.md
│   ├── phase2-implementation.md
│   ├── phase3-delivery.md
│   ├── wave-orchestrator.md
│   ├── subtask-group-worker.md
│   ├── execute-spec-orchestrator.md
│   ├── wave-lifecycle-agent.md
│   ├── pr-review-discovery.md
│   ├── pr-review-implementation.md
│   ├── comment-classifier.md
│   ├── future-classifier.md
│   ├── roadmap-integrator.md
│   ├── git-workflow.md
│   ├── project-manager.md
│   ├── test-discovery.md
│   ├── test-executor.md
│   └── test-reporter.md
├── memory/
│   ├── CLAUDE.md
│   └── rules/
│       ├── tdd-workflow.md
│       ├── git-conventions.md
│       └── execute-tasks.md
└── commands/                    # 11 commands
    ├── plan-product.md          # Mission & roadmap for new products
    ├── analyze-product.md       # Mission & roadmap for existing products
    ├── shape-spec.md            # Explore & refine requirements
    ├── create-spec.md           # Detailed specification
    ├── create-tasks.md          # Task breakdown with waves
    ├── execute-tasks.md         # TDD implementation
    ├── execute-spec.md          # Full automated workflow
    ├── pr-review-cycle.md       # PR feedback processing
    ├── debug.md                 # Root cause analysis
    ├── create-test-plan.md      # Browser test planning (v4.7)
    └── run-tests.md             # Browser test execution (v4.7)
```

## Size Comparison

| Component | v2.x Lines | v3.0 Lines | Reduction |
|-----------|------------|------------|-----------|
| execute-tasks.md | 475 | ~120 | **75%** |
| Phase files | 970 | 0 (native) | **100%** |
| task-sync skill | 290 | 0 (hooks) | **100%** |
| session-startup skill | 286 | 0 (hooks) | **100%** |
| **Total removed** | | | **~1,900 lines** |

## Dependencies

**Required (already in Claude Code):**
- `jq` - JSON processing (for task-operations.sh)
- `node` - JavaScript runtime (for json-to-markdown.js)
- `git` - Version control

**No MCP servers required.**

## Installation

```bash
# Fresh installation to a project
./setup/project.sh --claude-code --target /path/to/project

# Upgrade existing installation
./setup/project.sh --claude-code --upgrade --target /path/to/project
```

The installer reads version from `v3/settings.json` and copies all templates to the target project.

## Benefits

1. **More Reliable**: Hooks cannot be skipped
2. **Simpler**: ~50% less code to maintain
3. **Faster**: Native features, no Read tool overhead
4. **No Dependencies**: Uses only built-in Claude Code tools
5. **Cleaner**: Single-source data, shell script utilities
6. **Native**: Leverages Claude Code's built-in capabilities

## Answering: Do We Need Both tasks.json and tasks.md?

**No.** In v3 architecture:

- `tasks.json` is the **source of truth**
- `tasks.md` is **auto-generated** for human readability
- Hooks automatically regenerate MD when JSON changes
- No sync logic, no drift, no dedicated skill needed

## Version History (v3 Architecture)

| Version | Key Features |
|---------|--------------|
| v3.0 | Native hooks, single-source JSON, subagents |
| v4.0 | Wave orchestration, parallel execution |
| v4.5 | Execute-spec automation, PR review cycle |
| v4.6 | Wave-lifecycle-agent, browser testing workflow |
| v4.7 | Chrome MCP integration, AskUserQuestion in specs |
| **v4.7.1** | Current release |

See [CHANGELOG.md](../CHANGELOG.md) for detailed release notes.
