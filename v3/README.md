# Agent OS v3.0 - Native Claude Code Architecture

## Overview

Agent OS v3.0 is a major architectural refactor that leverages Claude Code's native capabilities to simplify the framework while improving reliability.

**No external dependencies** - uses only Claude Code's built-in tools (Bash, Read, Write, Grep, Task).

## Key Changes from v2.x

| Feature | v2.x | v3.0 |
|---------|------|------|
| **Task Format** | Dual (MD + JSON with sync) | Single-source JSON |
| **Instructions** | Embedded (250-900 lines/command) | Native memory hierarchy |
| **Phases** | Manual Read loading | Native subagents |
| **Validation** | Skills (can be skipped) | Hooks (mandatory) |
| **Task Sync** | task-sync skill | PostToolUse hook |
| **Recovery** | Custom state patterns | Native checkpointing |
| **Operations** | Inline code | Shell script utilities |

## Architecture

```
.claude/
├── CLAUDE.md                    # Core Agent OS memory (auto-loaded)
├── settings.json                # Hooks configuration
├── rules/
│   ├── tdd-workflow.md          # TDD rules (path-specific)
│   ├── git-conventions.md       # Git rules
│   └── execute-tasks.md         # Task execution rules
├── agents/
│   ├── phase1-discovery.md      # Task discovery (haiku)
│   ├── phase2-implementation.md # TDD implementation (sonnet)
│   └── phase3-delivery.md       # Completion workflow (sonnet)
├── hooks/
│   ├── session-start.sh         # Load progress context
│   ├── session-end.sh           # Save checkpoint
│   ├── post-file-change.sh      # Regenerate tasks.md
│   └── pre-commit-gate.sh       # Validate before commit
└── scripts/
    ├── json-to-markdown.js      # Generate MD from JSON
    └── task-operations.sh       # Task management utilities

.agent-os/
├── tasks/[spec]/
│   ├── tasks.json               # SOURCE OF TRUTH
│   └── tasks.md                 # Auto-generated (read-only)
├── progress/
│   └── progress.json            # Cross-session memory
└── state/
    ├── session.json             # Current session
    └── checkpoints/             # Recovery points
```

## Why These Changes?

### 1. Hooks Over Skills

**Problem**: Skills are model-invoked—Claude decides when to use them. This means validation could be skipped.

**Solution**: Hooks are deterministic. `PreToolUse` hooks **always run** before the tool executes. A pre-commit hook that blocks on failing tests cannot be bypassed.

### 2. Single-Source Task Format

**Problem**: v2.x had `tasks.md` as source of truth and `tasks.json` as machine-readable. This caused sync drift requiring a dedicated `task-sync` skill, startup validation, and commit gates.

**Solution**: `tasks.json` is the single source. `tasks.md` is auto-generated by hooks whenever JSON changes. No sync logic needed.

### 3. Native Subagents Over Phase Files

**Problem**: Phase files had to be loaded with the Read tool, with "MANDATORY" gates that could still be skipped.

**Solution**: Native subagents are invoked via Task tool with:
- `tools:` restriction (can't access unauthorized tools)
- `skills:` auto-loading (relevant skills always available)
- `model:` specification (use haiku for fast phases)

### 4. Memory Hierarchy Over Embedded Instructions

**Problem**: Commands were 250-900 lines with all instructions embedded for reliability.

**Solution**: Claude Code's native memory hierarchy:
- `.claude/CLAUDE.md` - Core instructions (always loaded)
- `.claude/rules/*.md` - Path-specific rules with YAML frontmatter
- Automatic loading by Claude Code (no Read tool needed)

### 5. Shell Script Over Inline Operations

**Problem**: Task operations were implemented inline in commands or via MCP servers.

**Solution**: Single shell script (`task-operations.sh`) provides all operations:
- Uses `jq` for JSON manipulation
- Uses `git` for artifact collection
- Uses `grep` for name validation
- Called via Bash tool (no external dependencies)

## Task Operations

All task management uses `.claude/scripts/task-operations.sh`:

```bash
# Get status
bash .claude/scripts/task-operations.sh status [spec_name]

# Update task
bash .claude/scripts/task-operations.sh update <task_id> <status>

# Add artifacts
bash .claude/scripts/task-operations.sh artifacts <task_id> <json>

# Collect artifacts from git
bash .claude/scripts/task-operations.sh collect-artifacts [since_commit]

# Validate names exist in codebase
bash .claude/scripts/task-operations.sh validate-names '["functionName"]'

# Get progress log
bash .claude/scripts/task-operations.sh progress [count] [type]

# Log progress entry
bash .claude/scripts/task-operations.sh log-progress <type> <description>
```

## Native Claude Code Agent Integration (v3.0.0)

v3.0 now includes Planning Mode and Explore agent integration:

### Planning Mode

Used in `/shape-spec` for formal exploration:

| Step | Tool | Purpose |
|------|------|---------|
| Start | `EnterPlanMode` | Restrict to read-only, signal exploration |
| End | `ExitPlanMode` | Get user approval, ready for implementation |

### Explore Agent

Integrated across commands with thoroughness levels:

| Command/Agent | Thoroughness | Use Case |
|---------------|--------------|----------|
| phase1-discovery | `quick` | Spec discovery, context loading |
| shape-spec (quick) | `quick` | Fast validation |
| shape-spec (standard) | `medium` | Balanced exploration |
| shape-spec (deep) | `very thorough` | Complex features |
| debug | `very thorough` | Root cause investigation |

## Files Created

```
v3/
├── README.md                    # This file
├── UPGRADE-PLAN.md              # Migration guide
├── schemas/
│   └── tasks-v3.json            # JSON schema for tasks
├── settings.json                # Hooks configuration
├── hooks/
│   ├── session-start.sh
│   ├── session-end.sh
│   ├── post-file-change.sh
│   └── pre-commit-gate.sh
├── scripts/
│   ├── json-to-markdown.js
│   └── task-operations.sh       # All task operations
├── agents/
│   ├── phase1-discovery.md      # + Explore agent integration
│   ├── phase2-implementation.md
│   └── phase3-delivery.md
├── memory/
│   ├── CLAUDE.md
│   └── rules/
│       ├── tdd-workflow.md
│       ├── git-conventions.md
│       └── execute-tasks.md
└── commands/
    ├── execute-tasks.md         # Simplified command
    ├── shape-spec.md            # NEW: Planning Mode + Explore
    └── debug.md                 # NEW: Explore agent for debugging
```

## Size Comparison

| Component | v2.x Lines | v3.0 Lines | Reduction |
|-----------|------------|------------|-----------|
| execute-tasks.md | 475 | ~120 | **75%** |
| Phase files | 970 | 0 (native) | **100%** |
| task-sync skill | 290 | 0 (hooks) | **100%** |
| session-startup skill | 286 | 0 (hooks) | **100%** |
| **Total removed** | | | **~1,900 lines** |

## Dependencies

**Required (already in Claude Code):**
- `jq` - JSON processing (for task-operations.sh)
- `node` - JavaScript runtime (for json-to-markdown.js)
- `git` - Version control

**No MCP servers required.**

## Installation (Future)

```bash
# Upgrade from v2.x
./setup/project.sh --claude-code --upgrade --v3

# Fresh v3.0 installation
./setup/project.sh --claude-code --v3
```

## Benefits

1. **More Reliable**: Hooks cannot be skipped
2. **Simpler**: ~50% less code to maintain
3. **Faster**: Native features, no Read tool overhead
4. **No Dependencies**: Uses only built-in Claude Code tools
5. **Cleaner**: Single-source data, shell script utilities
6. **Native**: Leverages Claude Code's built-in capabilities

## Answering: Do We Need Both tasks.json and tasks.md?

**No.** In v3.0:

- `tasks.json` is the **source of truth**
- `tasks.md` is **auto-generated** for human readability
- Hooks automatically regenerate MD when JSON changes
- No sync logic, no drift, no dedicated skill needed
